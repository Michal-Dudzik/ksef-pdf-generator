name: Build and Release

on:
  push:
    tags:
      - "v*.*.*" # Triggers on version tags like v0.0.37
  workflow_dispatch: # Allows manual trigger from GitHub UI

jobs:
  build:
    runs-on: windows-latest
    env:
      TZ: Europe/Warsaw

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        id: setup-node
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build

      - name: Run unit tests
        run: npm run test:unit

      - name: Run integration tests
        run: npm run test:integration

      - name: Get version from package.json
        id: package-version
        shell: pwsh
        run: |
          $version = node -p "require('./package.json').version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "Building version: $version"

      - name: Build standalone executable
        shell: pwsh
        run: |
          # Create SEA configuration
          if (-not (Test-Path "build")) { New-Item -ItemType Directory -Path "build" }
          @"
          {
            "main": "dist/cli.cjs",
            "output": "build/sea-prep.blob",
            "disableExperimentalSEAWarning": true,
            "useSnapshot": false,
            "useCodeCache": true
          }
          "@ | Out-File -FilePath "build/sea-config.json" -Encoding ASCII

          # Generate SEA blob
          node --experimental-sea-config build/sea-config.json

          # Create bin directory
          if (-not (Test-Path "bin")) { New-Item -ItemType Directory -Path "bin" }

          # Copy Node.js binary
          $exePath = "bin/ksef-pdf-generator.exe"
          Copy-Item (Get-Command node).Source $exePath

          # Inject application
          npx --yes postject $exePath NODE_SEA_BLOB build/sea-prep.blob --sentinel-fuse NODE_SEA_FUSE_fce680ab2cc467b6e072b8b5df1996b2

          # Verify the file was created
          if (Test-Path $exePath) {
            $size = (Get-Item $exePath).Length / 1MB
            Write-Host "[OK] Executable created: $exePath ($([math]::Round($size, 2)) MB)"
          } else {
            Write-Error "Failed to create executable"
            exit 1
          }

      - name: Prepare compressed executable copy
        shell: pwsh
        run: |
          $uncompressedPath = "bin/ksef-pdf-generator.exe"
          $compressedPath = "bin/ksef-pdf-generator-compressed.exe"
          Copy-Item $uncompressedPath $compressedPath -Force

          $size = (Get-Item $compressedPath).Length / 1MB
          Write-Host "[OK] Compressed executable copy prepared: $compressedPath ($([math]::Round($size, 2)) MB)"

      - name: Install UPX
        shell: pwsh
        run: |
          Write-Host "Installing UPX via Chocolatey..."
          choco install upx -y --no-progress

      - name: Compress executable with UPX
        shell: pwsh
        run: |
          $compressedPath = "bin/ksef-pdf-generator-compressed.exe"
          $sizeBefore = (Get-Item $compressedPath).Length

          Write-Host "Compressing with UPX..."
          upx --best --lzma $compressedPath

          $sizeAfter = (Get-Item $compressedPath).Length
          $saved = $sizeBefore - $sizeAfter
          $percent = [math]::Round(($saved / $sizeBefore) * 100, 1)

          Write-Host "[OK] Compressed from $([math]::Round($sizeBefore/1MB, 2))MB to $([math]::Round($sizeAfter/1MB, 2))MB"
          Write-Host "[OK] Saved: $([math]::Round($saved/1MB, 2))MB ($percent%)"
        continue-on-error: true

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            bin/ksef-pdf-generator.exe
            bin/ksef-pdf-generator-compressed.exe
          tag_name: ${{ github.ref_name }}
          name: Release ${{ steps.package-version.outputs.VERSION }}
          body: |
            ## KSeF PDF Generator v${{ steps.package-version.outputs.VERSION }}

            ### Installation
            Download one of the executables and use it directly - no installation required!

            - `ksef-pdf-generator.exe` (uncompressed, better antivirus compatibility)
            - `ksef-pdf-generator-compressed.exe` (UPX compressed, smaller file)

            ### Usage
            ```bash
            ksef-pdf-generator.exe -i input.xml -o output.pdf -t invoice
            ```

            ### Build Information
            - Built with Node.js ${{ steps.setup-node.outputs.node-version }}
            - Includes both compressed and uncompressed executables
            - All dependencies bundled

            ### Changes
            See [commit history](https://github.com/${{ github.repository }}/commits/${{ github.ref_name }}) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        shell: pwsh
        run: |
          $uncompressedPath = "bin/ksef-pdf-generator.exe"
          $compressedPath = "bin/ksef-pdf-generator-compressed.exe"

          $compressedSize = (Get-Item $compressedPath).Length / 1MB
          $uncompressedSize = (Get-Item $uncompressedPath).Length / 1MB

          Write-Host ""
          Write-Host "==========================================="
          Write-Host "[OK] Release Created Successfully!"
          Write-Host "==========================================="
          Write-Host "Version: ${{ steps.package-version.outputs.VERSION }}"
          Write-Host "Compressed:   $([math]::Round($compressedSize, 2)) MB ($compressedPath)"
          Write-Host "Uncompressed: $([math]::Round($uncompressedSize, 2)) MB ($uncompressedPath)"
          Write-Host "Release URL: ${{ steps.create_release.outputs.url }}"
          Write-Host "==========================================="
